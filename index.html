<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Figtree:wght@500&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="./style.css" />
    <title>Address Validator Form App</title>
  </head>
  <body>
    <h2>Address Form</h2>
    <form id="form">
      <input id="input" type="text" placeholder="Address" />
      <ul class="suggestions" id="suggestions"></ul>
      <div class="form-below">
        <div>
          <input placeholder="Apt, Unit, Suite or Floor #" id="apt" />
        </div>
        <div>
          <input placeholder="City" id="city" />
        </div>
        <div>
          <input placeholder="State/Region" id="state" />
        </div>
        <div>
          <input placeholder="Postal/Zip Code" id="postal" />
        </div>
        <div>
          <input placeholder="Country" id="country" />
        </div>
      </div>
      <br />
      <input type="submit" class="btn" />
    </form>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/@esri/arcgis-rest-request@4.0.0/dist/bundled/request.umd.js"></script>
    <script src="https://unpkg.com/@esri/arcgis-rest-geocoding@4.0.0/dist/bundled/geocoding.umd.js"></script>
    <script>
      let authentication = "";
      fetch(`/.netlify/functions/try`).then((res) => {
        authentication = arcgisRest.ApiKeyManager.fromKey(res.json());
        doStuff();
      });

      let sugg = [];

      let inputField = document.getElementById("input");
      let ulField = document.getElementById("suggestions");
      let apt = document.getElementById("apt");
      let city = document.getElementById("city");
      let state = document.getElementById("state");
      let postal = document.getElementById("postal");
      let country = document.getElementById("country");
      let form = document.getElementById("form");
      let address = "";
      let theCity = "";
      let theState = "";
      let thePostal = "";
      let theCountry = "";
      let value = {};

      //getting suggestions
      function doStuff() {
        inputField.addEventListener("input", ({ target }) => {
          arcgisRest
            .suggest(target.value, {
              params: { maxSuggestions: 5 },
              authentication,
            })
            .then((res) => {
              res.suggestions.forEach((item) => {
                sugg.push(item);
              });
              if (target.value) {
                inputField.setAttribute("autocomplete", "new-password");
              }
              changeAutoComplete(target.value);
            });
        });
      }

      //showing suggestions
      function changeAutoComplete(data) {
        ulField.innerHTML = ``;
        if (data.length > 0) {
          ulField.style.border = "1px solid gray";
          for (value of sugg) {
            const li = document.createElement("li");
            li.innerHTML = value.text;
            li.innerText = value.text;
            li.classList.add(value.magicKey);
            li.classList.add("list-group-item-action");
            li.classList.add("active");
            li.addEventListener("click", (event) => {
              inputField.removeAttribute("autocomplete");
              li.classList.remove("active");
              geo(event.target.className);
              ulField.style.border = "";
              ulField.innerHTML = "";
            });
            ulField.appendChild(li);
          }
          sugg = [];
        }
      }

      function geo(magicKey) {
        arcgisRest
          .geocode({
            magicKey,
            maxLocations: 1,
            outFields: "*",
            authentication,
          })
          .then((resu) => {
            let result = resu.candidates[0];
            console.log(result);
            result.attributes.StAddr
              ? (inputField.value = result.attributes.StAddr)
              : (inputField.value = result.attributes.ShortLabel);
            address = result.attributes.StAddr;
            theCity = result.attributes.City;
            city.value = result.attributes.City;
            theState = result.attributes.Region;
            state.value = result.attributes.Region;
            theCountry = result.attributes.CntryName;
            country.value = result.attributes.CntryName;
            thePostal = result.attributes.Postal;
            if (result.attributes.PostalExt) {
              postal.value = `${result.attributes.Postal}-${result.attributes.PostalExt}`;
            } else {
              postal.value = result.attributes.Postal;
            }
            postal.value = result.attributes.Postal;
            setAllFields();
          });
      }

      function setAllFields() {
        apt.addEventListener("change", (event) => {
          event.preventDefault();
          apt = event.target.value;
        });
        city.addEventListener("change", (event) => {
          event.preventDefault();
          theCity = event.target.value;
        });
        state.addEventListener("change", (event) => {
          event.preventDefault();
          theState = event.target.value;
        });
        postal.addEventListener("change", (event) => {
          event.preventDefault();
          thePostal = event.target.value;
        });
        country.addEventListener("change", (event) => {
          event.preventDefault();
          theCountry = event.target.value;
        });

        arcgisRest
          .geocode({
            address: address,
            city: theCity,
            region: theState,
            postal: thePostal,
            countryCode: theCountry,
            authentication,
          })
          .then((res) => {
            console.log(res.candidates[0].score);
          });
      }

      form.addEventListener("submit", (event) => {
        event.preventDefault();
        arcgisRest
          .geocode({
            address: address,
            city: theCity,
            region: theState,
            postal: thePostal,
            countryCode: theCountry,
            authentication,
          })
          .then((res) => {
            console.log(res.candidates[0]);
            if (res.candidates[0].score > 99) {
              alert("Form accepted!");
              window.location.reload(false);
            } else {
              alert("Please check address!");
            }
          });
      });
    </script>
  </body>
</html>
